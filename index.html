
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>æ—¥æœ¬æ±åŒ—ï¼å†°é›ªä¹‹æ—… 2026</title>

    <!-- External libs: Tailwind for styling, FontAwesome for icons, Vue 3 (global build), Firebase compat (realtime DB) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <script>
        /* Tailwind é¡å¤–é¡è‰²è¨­å®šï¼ˆå¯ä¾éœ€æ±‚æ“´å……ï¼‰ */
        tailwind.config = {
            theme: { extend: { colors: { 'snow-white':'#F0FFFF','ice-blue':'#B3E5FC','light-snow-blue':'#E5F3F7','deep-sea-blue':'#01579B','accent-yellow':'#FFD54F','soft-gray':'#F5F5F5' } } }
        };
    </script>

    <style>
        /* å…¨ç«™å­—å‹èˆ‡åŸºç¤é¡è‰² */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background:#E5F3F7; font-family:'Noto Sans TC',sans-serif; color:#334155; -webkit-tap-highlight-color:transparent; }

        /* App å®¹å™¨ï¼šé™åˆ¶å¯¬åº¦ã€ç½®ä¸­ã€è¦–è¦ºé™°å½± */
        .app-container{ max-width:480px;margin:0 auto;min-height:100vh;background:#fff;box-shadow:0 0 30px rgba(0,0,0,.05);position:relative;padding-bottom:90px; }

        /* Header èƒŒæ™¯èˆ‡åœ–ç‰‡ï¼šåœ“è§’èˆ‡æº¢å‡ºè™•ç† */
        .header-bg{ background:#fff; position:relative; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,.15); border-bottom-left-radius:35px;border-bottom-right-radius:35px; }
        .header-image-container{ height:250px; overflow:hidden; border-bottom-left-radius:35px;border-bottom-right-radius:35px; }
        .header-image-container img{ width:100%; height:100%; object-fit:cover; display:block; }

        /* é›ªèŠ±åœ–å±¤ï¼šç”¨ SVG data-uri æ¨¡æ“¬é£„é›ªæ•ˆæœ */
        .snow-layer{ position:absolute; inset:0; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23fff" opacity="0.8"/><circle cx="20" cy="80" r="0.5" fill="%23fff" opacity="0.6"/><circle cx="70" cy="30" r="1.5" fill="%23fff" opacity="0.9"/></svg>'); background-size:100px 100px; opacity:.7; animation:snowfall 10s linear infinite; z-index:5; }
        @keyframes snowfall{ to{ background-position:100px 100px; } }

        /* å´é‚Šåˆ†é æŒ‰éˆ•ç¾¤çµ„ */
        .side-tab-bar{ position:absolute; bottom:45px; right:16px; z-index:30; display:flex; gap:8px; }
        .tab-button{ width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-size:1.125rem;box-shadow:0 4px 10px rgba(0,0,0,.15); transition:all .2s; }
        .tab-button.active{ background:#01579B;color:#fff; transform:scale(1.05); box-shadow:0 6px 15px rgba(1,87,155,.4); }
        .tab-button:not(.active){ background:#fff;color:#B3E5FC; }

        .app-main{ padding-top:25px !important; position:relative; z-index:5; }

        /* éš±è—æ»¾å‹•æ¢ï¼ˆåƒ…è¦–è¦ºæ•ˆæœï¼‰ */
        .hide-scrollbar::-webkit-scrollbar{ display:none; } .hide-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

        .card-shadow{ box-shadow:0 4px 20px rgba(179,229,252,.3); transition:transform .2s,box-shadow .2s; }
        .animate-fade-in{ animation:fadeIn .4s ease-out; } @keyframes fadeIn{ from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none} }
        .fab-shadow{ box-shadow:0 4px 15px rgba(255,213,79,.5); }

        /* å‚™è¨»æ”¶åˆæ•ˆæœ */
        .note-content { 
        max-height: 4.5rem; /* é è¨­é«˜åº¦ï¼Œè‹¥å…§å®¹çŸ­å‰‡è‡ªå‹•é©æ‡‰ */
        overflow: hidden; 
        transition: max-height 0.3s ease-in-out;
        word-break: break-all; /* ä¿®æ­£ï¼šè§£æ±ºé•·ç¶²å€æº¢å‡ºå•é¡Œ */
        line-height: 1.5;
    } 
    .note-content.expanded { 
        max-height: 2000px; /* å±•é–‹å¾Œéš¨å…§å®¹å¢é«˜ */
    }
    /* äº¤é€šå‚™è¨»ï¼šç§»é™¤å¯¬åº¦é™åˆ¶ï¼Œæ”¹ç‚ºè‡ªå‹•æ›è¡Œä¸¦éš¨å…§å®¹å¢é«˜ */
.transport-note-box {
    word-break: break-all;
    overflow-wrap: break-word;
    white-space: normal; /* è¦†è“‹åŸæœ¬å¯èƒ½å°è‡´ä¸æ›è¡Œçš„è¨­å®š */
    display: inline-block;
    max-width: 100%; /* ç¢ºä¿ä¸è¶…éçˆ¶å®¹å™¨å¯¬åº¦ */
}

        /* èŠ±è²»æ¨™ç±¤åœ“å½¢ */
        .expense-category-tag{ min-width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.1); }
        .expenses-banner{ background:linear-gradient(135deg,#01579B 0%,#0097A7 100%); }

        .date-selector-sticky{ background:#fff;border-bottom:1px solid #f0f0f0; z-index:20; top:0; }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <!-- Header å€ï¼šèƒŒæ™¯åœ– + é›ªèŠ±å±¤ + å´é‚Šåˆ†é æŒ‰éˆ• -->
    <div class="header-bg relative">
        <div class="header-image-container"><img src="0.jpg" alt="æ—¥æœ¬æ±åŒ—ä¹‹æ—…"></div>
        <div class="snow-layer"></div>

        <!-- å´é‚Š tab æŒ‰éˆ•ï¼šåˆ‡æ› itinerary / info / shopping / expenses -->
        <div class="side-tab-bar">
            <button @click="currentTab='itinerary'" :class="{'active':currentTab==='itinerary'}" class="tab-button" title="è¡Œç¨‹"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab='info'" :class="{'active':currentTab==='info'}" class="tab-button" title="è³‡è¨Š"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab='shopping'" :class="{'active':currentTab==='shopping'}" class="tab-button" title="è³¼ç‰©"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab='expenses'" :class="{'active':currentTab==='expenses'}" class="tab-button" title="èŠ±è²»"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <main class="p-4 app-main">
        <!-- ==========================
             ITINERARYï¼ˆè¡Œç¨‹ï¼‰åˆ†é 
             - æ—¥æœŸæ©«å‘æ»‘å‹•é¸æ“‡
             - é¡¯ç¤ºç•¶æ—¥å¤©æ°£
             - åˆ—è¡¨å‘ˆç¾ç•¶å¤©è¡Œç¨‹ï¼ˆå¯æ–°å¢/ç·¨è¼¯/æ’åº/åœ°åœ–å°èˆªï¼‰
           ========================== -->
        <section v-if="currentTab==='itinerary'" class="animate-fade-in">
            <!-- æ—¥æœŸé¸æ“‡å™¨ï¼ˆæ©«å‘ï¼‰ -->
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                <div v-for="(d,i) in dates" :key="i" @click="selectedDateIndex=i"
                     class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex===i ? 'bg-deep-sea-blue text-white border-blue-400 shadow-xl scale-110 z-10' : 'bg-white text-slate-500 border-slate-200 shadow-sm'">
                    <span class="text-sm font-bold uppercase tracking-wider">{{ d.weekday }}</span>
                    <span class="text-xs font-medium opacity-70">{{ d.date }}</span>
                </div>
            </div>

            <!-- ç•¶æ—¥å¤©æ°£å¡ç‰‡ï¼ˆä½¿ç”¨ weatherDataï¼‰ -->
            <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md">
                <div class="flex items-start text-deep-sea-blue space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-5xl text-blue-500"></i>
                    <div class="pt-1">
                        <div class="flex items-baseline">
                            <span class="text-3xl font-extrabold leading-none text-red-500">{{ weatherData[selectedDateIndex].tempMax || 0 }}Â°</span>
                            <span class="mx-1 text-slate-300 text-lg">/</span>
                            <span class="text-2xl font-bold leading-none text-blue-500">{{ weatherData[selectedDateIndex].tempMin || 0 }}Â°</span>
                            <span class="text-xs font-light text-slate-500 ml-1">C</span>
                        </div>
                        <span class="block text-xs text-slate-500 mt-1 font-medium">é«”æ„Ÿ: {{ weatherData[selectedDateIndex].feel || 0 }}Â°C</span>
                    </div>
                </div>
                <div class="text-right text-xs text-slate-600 pl-3">
                    <span class="font-bold block text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    <span class="mt-1 block text-deep-sea-blue font-bold">{{ weatherData[selectedDateIndex].locationName || 'æ±åŒ—åœ°å€' }}</span>
                </div>
            </div>

            <!-- è¡Œç¨‹æ¸…å–®ï¼ˆå¯æ’åºã€ç·¨è¼¯ã€æ‰“é–‹åœ°åœ–ï¼‰ -->
            <div class="space-y-4">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                    <div v-if="idx>0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
    <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
    <i :class="getTransportIcon(item.transportType)" class="mr-2 text-slate-300 cursor-pointer hover:text-deep-sea-blue" @click="openMapDirections(currentItinerary[idx-1], item)"></i>
    
    <span class="font-bold">{{ item.travelTime || 'ç§»å‹•ä¸­' }}</span>

    <span v-if="item.transitTime || item.transNote" class="ml-2 px-2 py-0.5 bg-slate-100 rounded text-[12px] text-slate-500 font-medium align-middle transport-note-box">
        <span v-if="item.transitTime" class="text-red-500 font-bold">
            <i class="fa-regular fa-clock text-[10px] mr-1"></i>{{ item.transitTime }}
        </span>
        
        <span v-if="item.transitTime && item.transNote" class="mx-1 opacity-30">|</span>
        
        <span v-if="item.transNote">{{ item.transNote }}</span>
    </span>
</div>

                    <article class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-ice-blue/50 min-h-[150px]" :class="item.category==='flight' ? 'bg-slate-50 border-blue-200':''">
                        <!-- å·¦å´åœ–ç¤ºï¼ˆé¡åˆ¥ï¼‰èˆ‡æ™‚é–“ -->
                        <div class="mr-4 flex flex-col items-center min-w-[52px]">
                            <div class="w-10 h-10 rounded-full text-white shadow-lg flex items-center justify-center text-sm mb-1" :class="getCategoryColor(item.category)"><i :class="getCategoryIcon(item.category)"></i></div>
                            <span v-if="item.startTime" class="text-[13px] font-black text-slate-500 mt-1 tracking-tighter">{{ item.startTime }}</span>
                        </div>

                        <!-- ä¸»è¦å…§å®¹ï¼šåç¨±ã€åœ°å€ã€å‚™è¨» -->
                        <div class="flex-1 pb-1">
                            <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight pr-8">{{ item.name }}</h3>
                            <div class="text-sm text-slate-500 space-y-1.5 mt-2">
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-ice-blue"></i> ç‡Ÿæ¥­: {{ item.hours }}</p>
                                <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-ice-blue"></i> {{ item.price }}</p>
                                <p v-if="item.address" class="flex items-start"><i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-ice-blue"></i> {{ item.address }}</p>
                            </div>

                            <!-- å‚™è¨»å€ï¼šæ”¯æ´é€£çµè½‰æ›èˆ‡æ”¶åˆ -->
                            <div v-if="item.note && item.note.length" class="mt-3 text-xs bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                <p class="text-slate-600 font-bold mb-1 flex items-center"><i class="fa-solid fa-highlighter text-accent-yellow mr-2"></i> å‚™è¨»</p>
                                <div class="note-content whitespace-pre-wrap" :class="{'expanded': item.isNoteExpanded}" v-html="renderNote(item.note)"></div>
                                <button v-if="item.note.length>50" @click="item.isNoteExpanded=!item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-1 block">{{ item.isNoteExpanded ? 'æ”¶åˆå‚™è¨»' : 'æŸ¥çœ‹æ›´å¤š...' }}</button>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ•ï¼šä¸Š/ä¸‹ç§»ã€æ‰“é–‹åœ°åœ–ã€ç·¨è¼¯ -->
                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button v-if="idx>0" @click.stop="moveItineraryUp(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors"><i class="fa-solid fa-arrow-up"></i></button>
                            <button v-if="idx<currentItinerary.length-1" @click.stop="moveItineraryDown(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors"><i class="fa-solid fa-arrow-down"></i></button>
                            <button @click.stop="openMap(item.address||item.name)" class="w-7 h-7 bg-ice-blue text-deep-sea-blue rounded-full flex items-center justify-center text-xs hover:bg-deep-sea-blue hover:text-white transition-colors"><i class="fa-solid fa-location-arrow"></i></button>
                            <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-200 transition-colors"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                    </article>
                </div>

                <!-- ç•¶å¤©ç„¡è¡Œç¨‹æç¤º -->
                <div v-if="currentItinerary.length===0" class="text-center py-16 text-slate-300">
                    <i class="fa-solid fa-map-location-dot text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">æœ¬æ—¥å°šç„¡è¡Œç¨‹<br>è«‹é»æ“Šå³ä¸‹è§’æ–°å¢</p>
                </div>
            </div>
        </section>

        <!-- ==========================
             INFOï¼ˆè³‡è¨Šï¼‰åˆ†é 
             - åŒ¯ç‡æ›ç®—å°å·¥å…·
             - èˆªç­ã€ä½å®¿ç­‰å›ºå®šè³‡è¨Šå±•ç¤º
           ========================== -->
        <section v-if="currentTab==='info'" class="space-y-5 animate-fade-in">
            <!-- åŒ¯ç‡æ›ç®—å€å¡Šï¼ˆcurrencyInput ä¹˜ä»¥ EXCHANGE_RATEï¼‰ -->
            <div class="bg-gradient-to-r from-deep-sea-blue to-cyan-700 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <h3 class="font-bold text-lg mb-4 flex items-center"><i class="fa-solid fa-calculator mr-2"></i> åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center justify-between space-x-3">
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1 uppercase tracking-wider">JPY (æ—¥å¹£)</label>
                        <input type="number" v-model.number="currencyInput" @input="calculateCurrency" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none text-lg font-bold" placeholder="Â¥"/>
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-cyan-300 mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-cyan-200 block mb-1 uppercase tracking-wider">TWD (å°å¹£)</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2.5 text-white text-lg font-bold border border-transparent">$ {{ currencyResult }}</div>
                    </div>
                </div>
                <p class="text-[10px] text-cyan-300 mt-3 text-right">åŒ¯ç‡åŸºæº–: {{ EXCHANGE_RATE }}</p>
            </div>

            <!-- å›ºå®šèˆªç­è³‡è¨Šï¼ˆé¡¯ç¤ºç”¨ï¼‰ -->
            <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> èˆªç­è³‡è¨Š (æ·æ˜Ÿèˆªç©º)</h3>
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                        <div class="flex justify-between text-sm font-bold text-deep-sea-blue mb-1"><span>TPE æ¡ƒåœ’</span><i class="fa-solid fa-plane text-xs"></i><span>NRT æˆç”°</span></div>
                        <div class="flex justify-between text-xs text-slate-500"><span>02:30 (2/20)</span><span>A321neo</span><span>06:35</span></div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                        <div class="flex justify-between text-sm font-bold text-orange-800 mb-1"><span>NRT æˆç”°</span><i class="fa-solid fa-plane text-xs"></i><span>TPE æ¡ƒåœ’</span></div>
                        <div class="flex justify-between text-xs text-slate-500"><span>22:25 (2/27)</span><span>A321neo</span><span>01:30</span></div>
                    </div>
                </div>
            </div>

            <!-- ä½å®¿è³‡è¨Šåˆ—è¡¨ï¼ˆhotelsï¼‰ -->
            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-hotel text-indigo-500 mr-2"></i> ä½å®¿è³‡è¨Š</h3>
                <ul class="space-y-5">
                    <li v-for="hotel in hotels" :key="hotel.name" class="border-b last:border-0 pb-4 last:pb-0">
                        <div class="flex justify-between items-start group">
                            <div class="flex-1">
                                <span class="font-bold block text-slate-700 text-lg">{{ hotel.name }}</span>
                                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                            </div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <div class="text-sm text-slate-500 mt-2"><p class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-slate-300"></i> {{ hotel.time }}</p></div>
                    </li>
                </ul>
            </div>
        </section>

        <!-- ==========================
             SHOPPINGï¼ˆè³¼ç‰©ï¼‰åˆ†é 
             - è²·å®¶ç¯©é¸æŒ‰éˆ•
             - é¡¯ç¤ºæ¯ä½è²·å®¶çš„è³¼ç‰©æ¸…å–®ï¼ˆåœ–ç‰‡æ”¯æ´ï¼‰
           ========================== -->
        <section v-if="currentTab==='shopping'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-2 pb-4 mb-2 sticky top-0 bg-white z-20 -mx-4 px-4 pt-1">
                <button v-for="p in buyers" :key="p" @click="selectedBuyer=p" :class="selectedBuyer===p ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all">{{ p }}</button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div v-for="item in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="aspect-square bg-slate-50 rounded-xl mb-3 overflow-hidden relative border border-slate-100">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="fa-solid fa-bag-shopping text-3xl"></i></div>
                        <button @click="removeShoppingItem(item.id)" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <p class="font-bold text-sm text-slate-800 truncate px-1">{{ item.name }}</p>
                    <p class="text-[10px] text-slate-400 px-1 mt-0.5"><i class="fa-solid fa-user text-[8px] mr-1"></i>{{ item.buyer }}</p>
                </div>

                <div v-if="filteredShoppingList.length===0" class="col-span-2 text-center py-16 text-slate-300">
                    <i class="fa-solid fa-cart-plus text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">ç›®å‰ {{ selectedBuyer }} çš„æ¸…å–®æ˜¯ç©ºçš„<br>é»æ“Šå³ä¸‹è§’æ–°å¢</p>
                </div>
            </div>
        </section>

        <!-- ==========================
             EXPENSESï¼ˆèŠ±è²»ï¼‰åˆ†é 
             - å€‹äººæ‡‰ä»˜æ¬¾çµ±è¨ˆï¼ˆpersonOwesï¼‰
             - ç•¶æ—¥çµç®—å»ºè­°ï¼ˆsettlementsï¼‰
             - æ¯æ—¥çµ±è¨ˆ/æ˜ç´°ï¼ˆfilteredExpensesï¼‰
           ========================== -->
        <section v-if="currentTab==='expenses'" class="animate-fade-in">
            <div class="mb-6">
                <h4 class="text-xs font-bold text-slate-500 mb-3 pl-1"><i class="fa-solid fa-users mr-2 text-deep-sea-blue"></i>å€‹äººæ”¯å‡ºç¸½è¨ˆ (JPY)</h4>
                <div class="flex overflow-x-auto gap-3 hide-scrollbar py-2">
                    <div v-for="(amt,name) in personOwes" :key="name" class="expenses-banner min-w-[140px] text-white rounded-2xl p-4 shadow-lg relative overflow-hidden flex-shrink-0">
                        <div class="absolute -right-4 -top-4 bg-white/10 w-16 h-16 rounded-full blur-xl"></div>
                        <p class="text-[10px] text-cyan-100 opacity-80 mb-1">{{ name }}</p>
                        <h2 class="text-xl font-bold">Â¥ {{ formatNumber(Math.round(amt)) }}</h2>
                        <p class="text-[9px] mt-1 opacity-70">ç´„ NT$ {{ formatNumber(Math.round(amt * EXCHANGE_RATE)) }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-4 mb-4 card-shadow mx-1 border border-ice-blue/50">
                <h4 class="text-xs font-bold text-slate-500 mb-3 flex justify-between"><span><i class="fa-solid fa-hand-holding-dollar mr-2 text-deep-sea-blue"></i>{{ dates[expenseDateIndex].date }} çµç®— (èª°çµ¦èª°)</span><span class="text-[10px] text-slate-400">JPY</span></h4>
                <div class="space-y-2">
                    <div v-for="(s,idx) in settlements" :key="idx" class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center space-x-2"><span class="font-bold text-slate-700 text-sm">{{ s.from }}</span><i class="fa-solid fa-arrow-right text-[10px] text-slate-300"></i><span class="font-bold text-deep-sea-blue text-sm">{{ s.to }}</span></div>
                        <div class="text-right"><p class="text-xs font-black text-red-500">Â¥ {{ formatNumber(s.amount) }}</p></div>
                    </div>
                    <div v-if="settlements.length===0" class="text-center py-2 text-slate-400 text-xs italic">æœ¬æ—¥å¸³ç›®å·²å¹³</div>
                </div>
            </div>

            <div class="mb-6 mx-1">
                <h4 class="text-xs font-bold text-slate-500 mb-3 pl-1"><i class="fa-solid fa-calendar-day mr-2 text-orange-400"></i>æ¯æ—¥çµ±è¨ˆ</h4>
                <div class="flex overflow-x-auto gap-2 hide-scrollbar">
                    <div v-for="(d,i) in dates" :key="d.date" @click="expenseDateIndex=i" class="min-w-[85px] p-2 rounded-xl border text-center flex-shrink-0 cursor-pointer" :class="expenseDateIndex===i ? 'bg-blue-50 border-deep-sea-blue shadow-sm' : 'bg-white border-slate-100'">
                        <p class="text-[10px]" :class="expenseDateIndex===i ? 'text-deep-sea-blue font-bold' : 'text-slate-400'">{{ d.date }}</p>
                        <p class="text-xs font-bold" :class="expenseDateIndex===i ? 'text-deep-sea-blue' : 'text-slate-700'">Â¥{{ formatNumber(dailyExpenses[d.date]||0) }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[400px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4">
                <p class="text-[10px] text-slate-400 font-bold mb-4 uppercase tracking-widest">{{ dates[expenseDateIndex].date }} æ¶ˆè²»æ˜ç´° ({{ filteredExpenses.length }} ç­†)</p>

                <div v-for="(exp,idx) in filteredExpenses" :key="idx" class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="expense-category-tag mr-4 text-white" :class="getCategoryColor(exp.category)">{{ getCategoryLabel(exp.category) }}</div>
                        <div><p class="font-bold text-slate-700 text-sm mb-0.5">{{ exp.name }}</p><p class="text-[10px] text-slate-400 uppercase tracking-wide">{{ exp.payer }} å¢Šä»˜ ({{ exp.splitMembers?.length }}äººåˆ†)</p></div>
                    </div>
                    <div class="text-right flex items-center">
                        <p class="font-bold text-slate-700 text-sm">Â¥{{ formatNumber(exp.amount) }}</p>
                        <button @click="removeExpense(exp)" class="w-5 h-5 ml-3 text-red-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>

                <div v-if="filteredExpenses.length===0" class="text-center py-10 text-slate-300"><p class="text-sm italic">æœ¬æ—¥ç„¡æ¶ˆè²»è¨˜éŒ„</p></div>
            </div>
        </section>
    </main>

    <!-- å…¨åŸŸæ–°å¢æŒ‰éˆ•ï¼ˆFABï¼‰ -->
    <button v-if="currentTab!=='info'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-deep-sea-blue text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40"><i class="fa-solid fa-plus"></i></button>

    <!-- ==========================
         Modal å€ï¼ˆä¸‰ç¨®ï¼šitinerary / shopping / expenseï¼‰
         - ç‚ºäº†ç°¡æ½”æ€§ï¼Œè¡¨å–®æ¬„ä½èˆ‡æŒ‰éˆ•èˆ‡åŸæœ¬åŠŸèƒ½ä¸€è‡´
       ========================== -->
    <!-- ITINERARY Modalï¼šæ–°å¢ / ç·¨è¼¯è¡Œç¨‹ -->
<div v-if="showItineraryModal" class="fixed inset-0 bg-[#01579B]/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[32px] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade-in">
            <div class="p-5 overflow-y-auto">
                <div class="flex justify-between items-center mb-5 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-5 bg-deep-sea-blue rounded-full"></div>
                        <h3 class="text-lg font-bold text-slate-800">{{ isEditMode ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢é …ç›®' }}</h3>
                    </div>
                    <button @click="showItineraryModal = false" class="w-7 h-7 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full hover:bg-slate-200">
                        <i class="fa-solid fa-xmark text-sm"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex flex-col gap-1.5">
                            <label class="text-[11px] font-bold text-slate-400 ml-1">è¡Œç¨‹åç¨±</label>
                            <input v-model="newItinerary.name" placeholder="è¦å»å“ªï¼Ÿ" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm focus:ring-2 focus:ring-blue-100 font-medium"/>
                        </div>
                        <div class="flex flex-col gap-1.5">
                            <label class="text-[11px] font-bold text-slate-400 ml-1">æ´»å‹•åˆ†é¡</label>
                            <select v-model="newItinerary.category" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm focus:ring-2 focus:ring-blue-100 appearance-none font-medium text-slate-700 h-[48px]">
                                <option value="sightseeing">ğŸ“¸ æ™¯é»</option>
                                <option value="food">ğŸ± ç¾é£Ÿ</option>
                                <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                                <option value="accommodation">ğŸ¨ ä½å®¿</option>
                                <option value="transport">ğŸšŒ äº¤é€š</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="flex flex-col gap-1.5">
    <label class="text-[11px] font-bold text-slate-400 ml-1">é–‹å§‹æ™‚é–“</label>
    <div class="relative h-[48px]">
        <input v-model="newItinerary.startTime" type="time" 
               class="w-full bg-slate-50 border-none rounded-xl px-4 h-full text-sm focus:ring-2 focus:ring-blue-100 font-medium block appearance-none relative z-10"
               style="-webkit-appearance: none; -moz-appearance: none; background-color: #f8fafc;"/>
        <i class="fa-regular fa-clock absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 z-0 text-xs"></i>
    </div>
</div>
                        <div class="flex flex-col gap-1.5">
                            <label class="text-[11px] font-bold text-slate-400 ml-1">åœ°é»åœ°å€</label>
                            <input v-model="newItinerary.address" placeholder="åœ°é»æˆ–åœ°å€" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm focus:ring-2 focus:ring-blue-100 font-medium h-[48px]"/>
                        </div>
                    </div>

                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-bold text-slate-400 ml-1">è©³ç´°å‚™è¨»</label>
                        <textarea v-model="newItinerary.note" placeholder="è©³ç´°å…§å®¹..." rows="2" 
                                  class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm focus:ring-2 focus:ring-blue-100 min-h-[80px] font-medium"></textarea>
                    </div>

                    <div class="bg-blue-50/50 rounded-2xl p-4 space-y-3 border border-blue-100/30">
                        <div class="flex items-center text-deep-sea-blue text-[10px] font-bold uppercase tracking-wider mb-1">
                            <i class="fa-solid fa-bus mr-2"></i>äº¤é€šè³‡è¨Š
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex bg-white/60 p-1 rounded-lg gap-1">
                                <button v-for="t in ['walk','car','public','flight']" :key="t"
                                        @click="newItinerary.transportType = t"
                                        :class="newItinerary.transportType === t ? 'bg-deep-sea-blue text-white shadow-sm' : 'text-slate-400'"
                                        class="flex-1 py-1.5 rounded-md text-[10px] transition-all">
                                    <i :class="getTransportIcon(t)"></i>
                                </button>
                            </div>
                            <input v-model="newItinerary.transitTime" placeholder="ç­æ¬¡æ™‚åˆ» (ç´…)" class="w-full bg-white border-none rounded-lg px-3 py-2 text-xs text-red-500 font-bold shadow-sm focus:ring-1 focus:ring-red-200"/>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model="newItinerary.travelTime" placeholder="é è¨ˆæ™‚é•· (å¦‚ 45m)" class="w-full bg-white border-none rounded-lg px-3 py-2 text-xs font-medium shadow-sm"/>
                            <input v-model="newItinerary.transNote" placeholder="è½‰ä¹˜å‚™è¨»" class="w-full bg-white border-none rounded-lg px-3 py-2 text-xs font-medium shadow-sm"/>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 bg-slate-50 border-t border-slate-100">
                <div class="grid grid-cols-2 gap-3">
                    <button v-if="isEditMode" @click="deleteItineraryItem" class="bg-red-50 text-red-500 font-bold py-3.5 rounded-xl hover:bg-red-100 active:scale-95 transition-all text-xs">åˆªé™¤é …ç›®</button>
                    <button @click="saveItineraryItem" :class="isEditMode ? '' : 'col-span-2'" class="bg-deep-sea-blue text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 hover:brightness-110 active:scale-95 transition-all text-xs">
                        {{ isEditMode ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªåŠ å…¥è¡Œç¨‹' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showShoppingModal" class="fixed inset-0 bg-[#01579B]/30 backdrop-blur-sm z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-[32px] w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <h3 class="font-bold text-center mb-6 text-slate-800 text-lg">æ–°å¢è³¼ç‰©é …ç›®</h3>
            <div class="mb-6 text-center">
                <div @click="$refs.fileInput.click()" class="w-28 h-28 bg-slate-50 rounded-[24px] mx-auto flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-slate-200 overflow-hidden relative group">
                    <img v-if="newShoppingItem.image" :src="newShoppingItem.image" class="w-full h-full object-cover">
                    <div v-else class="text-slate-300"><i class="fa-solid fa-camera text-2xl mb-1"></i><p class="text-[10px]">ä¸Šå‚³ç…§ç‰‡</p></div>
                </div>
                <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleImageUpload"/>
            </div>
            <input v-model="newShoppingItem.name" placeholder="æƒ³è²·ä»€éº¼å‘¢ï¼Ÿ" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm mb-8"/>
            <div class="grid grid-cols-2 gap-3">
                <button @click="showShoppingModal=false" class="bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl text-sm">å–æ¶ˆ</button>
                <button @click="addShoppingItem" class="bg-deep-sea-blue text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 text-sm">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 bg-[#01579B]/30 backdrop-blur-sm z-50 flex items-center justify-center p-6 overflow-y-auto">
        <div class="bg-white rounded-[32px] w-full max-w-sm p-6 shadow-2xl my-auto animate-fade-in">
            <h3 class="font-bold text-center mb-6 text-slate-800 text-lg">è¨˜ä¸€ç­†æ¶ˆè²»</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex flex-col gap-1.5"><label class="text-xs text-slate-400 font-bold">åˆ†é¡</label><select v-model="newExpense.category" class="bg-slate-50 rounded-2xl p-4 text-sm outline-none"><option value="food">ğŸ± ç¾é£Ÿ</option><option value="sightseeing">ğŸ“¸ æ™¯é»</option><option value="transport">ğŸšŒ äº¤é€š</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="other">âœ¨ å…¶ä»–</option></select></div>
                    <div class="flex flex-col gap-1.5"><label class="text-xs text-slate-400 font-bold">é‡‘é¡ (JPY)</label><input v-model.number="newExpense.amount" type="number" placeholder="Â¥ 0" class="bg-slate-50 rounded-2xl p-4 text-sm font-bold text-red-500 outline-none"/></div>
                </div>
                <div class="flex flex-col gap-1.5"><label class="text-xs text-slate-400 font-bold">é …ç›®åç¨±</label><input v-model="newExpense.name" placeholder="æ”¯å‡ºç´°ç›®" class="bg-slate-50 rounded-2xl p-4 text-sm outline-none"/></div>
                <div class="pt-2"><label class="text-xs text-slate-400 font-bold block mb-2">èª°å…ˆå¢Šä»˜ï¼Ÿ</label><div class="flex flex-wrap gap-2"><button v-for="m in groupMembers" :key="'p'+m" @click="newExpense.payer=m" :class="newExpense.payer===m ? 'bg-deep-sea-blue text-white shadow-md' : 'bg-slate-50 text-slate-400'" class="px-3 py-2 rounded-xl text-xs font-bold transition-all">{{ m }}</button></div></div>
                <div class="pt-2"><label class="text-xs text-slate-400 font-bold block mb-2">èª°è¦åˆ†æ”¤ï¼Ÿ</label><div class="flex flex-wrap gap-2"><button v-for="m in groupMembers" :key="'s'+m" @click="toggleSplitMember(m)" :class="newExpense.splitMembers.includes(m) ? 'bg-cyan-600 text-white shadow-md' : 'bg-slate-50 text-slate-400'" class="px-3 py-2 rounded-xl text-xs font-bold transition-all">{{ m }}</button></div></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-8">
                <button @click="showExpenseModal=false" class="bg-slate-100 text-slate-500 font-bold py-4 rounded-2xl text-sm">å–æ¶ˆ</button>
                <button @click="addExpense" class="bg-accent-yellow text-deep-sea-blue font-bold py-4 rounded-2xl shadow-lg text-sm">å„²å­˜é …ç›®</button>
            </div>
        </div>
    </div>

<!-- ==========================
     JavaScriptï¼ˆVue App + Firebaseï¼‰
     - æˆ‘åœ¨ä¸‹æ–¹ä»¥å€å¡Šè¨»è§£èªªæ˜æ¯ä¸€æ®µç”¨é€”
   ========================== -->
<script>
/* --------------------------
   Firebase (compat) åˆå§‹åŒ–
   - ä½¿ç”¨ Realtime Database
   - tripRef ç‚ºåŒæ­¥çš„ç¯€é»ï¼ˆtrip_2025ï¼‰
   -------------------------- */
/* --------------------------
   Firebase (compat) åˆå§‹åŒ–
   -------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyCcZkVvFk52AcfGu0cEENsD5jYJs1O2HZo",
    authDomain: "japantrip2026-da446.firebaseapp.com",
    databaseURL: "https://japantrip2026-da446-default-rtdb.firebaseio.com",
    projectId: "japantrip2026-da446",
    storageBucket: "japantrip2026-da446.firebasestorage.app",
    messagingSenderId: "441435573496",
    appId: "1:441435573496:web:7dd1eb9cc25f6ff1f53f0d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tripRef = db.ref('trip_2025');

const { createApp, ref, computed, watch, onMounted } = Vue;

createApp({
    setup(){
        const EXCHANGE_RATE = 0.215;
        const currentTab = ref('itinerary');
        const selectedDateIndex = ref(0);
        const expenseDateIndex = ref(0);

        const itineraryData = ref([[],[],[],[],[],[],[],[]]);
        const shoppingList = ref([]);
        const expenses = ref([]);
        const weatherData = ref({});

        const buyers = ref(['ç‡•å¦‚','æ€¡å›','éˆæ™','å˜‰ç·¯','æ·‘ç‘©','æœˆé›²']);
        const selectedBuyer = ref(buyers.value[0]);
        const groupMembers = ['ç‡•å¦‚','æ€¡å›','éˆæ™','å˜‰ç·¯','æ·‘ç‘©','æœˆé›²'];

        const dates = ref([
            {date:'2/20',weekday:'äº”'},{date:'2/21',weekday:'å…­'},{date:'2/22',weekday:'æ—¥'},{date:'2/23',weekday:'ä¸€'},
            {date:'2/24',weekday:'äºŒ'},{date:'2/25',weekday:'ä¸‰'},{date:'2/26',weekday:'å››'},{date:'2/27',weekday:'äº”'}
        ]);

        const hotels = ref([
            {name:'äº¬é˜ªä»™è‡ºé£¯åº—',location:'Sendai',date:'2/20 - 2/22',time:'In 15:00 / Out 11:00'},
            {name:'æ¾å³¶å°æ¾é¤¨å¥½é¢¨äº­',location:'Matsushima',date:'2/23',time:'In 15:00 / Out 10:00'},
            {name:'å…©åœ‹ä¼‘é›·è“‹ç‰¹é…’åº—',location:'Tokyo',date:'2/24 - 2/27',time:'In 15:00 / Out 11:00'}
        ]);

        const showItineraryModal = ref(false), showShoppingModal = ref(false), showExpenseModal = ref(false), isEditMode = ref(false);
        const currencyInput = ref(10000), currencyResult = ref(0);

        // ä¿®æ­£ï¼šç¢ºä¿ newItinerary åŒ…å«æ‰€æœ‰æ¬„ä½
        const newItinerary = ref({ 
            id: null, name: '', category: 'sightseeing', startTime: '', 
            address: '', note: '', transportType: 'car', travelTime: '', 
            transNote: '', transitTime: '', isNoteExpanded: false 
        });
        const newShoppingItem = ref({ name:'', image:null });
        const newExpense = ref({ name:'', amount:null, category:'food', date:'', payer:groupMembers[0], splitMembers:[...groupMembers] });

        const CATEGORY_MAP = {
            sightseeing:{color:'bg-green-500',icon:'fa-solid fa-camera'},
            food:{color:'bg-red-500',icon:'fa-solid fa-utensils'},
            shopping:{color:'bg-indigo-500',icon:'fa-solid fa-bag-shopping'},
            accommodation:{color:'bg-purple-500',icon:'fa-solid fa-bed'},
            flight:{color:'bg-blue-500',icon:'fa-solid fa-plane'},
            transport:{color:'bg-orange-500',icon:'fa-solid fa-car'}
        };

        const currentItinerary = computed(()=> itineraryData.value[selectedDateIndex.value] || []);
        const filteredShoppingList = computed(()=> shoppingList.value.filter(i=>i.buyer===selectedBuyer.value));

        const dailyExpenses = computed(()=> {
            const d = {};
            expenses.value.forEach(e => { d[e.date] = (d[e.date]||0) + Number(e.amount||0); });
            return d;
        });

        const personOwes = computed(()=> {
            const t = {}; groupMembers.forEach(m=>t[m]=0);
            expenses.value.forEach(e=> {
                const per = Number(e.amount||0) / (e.splitMembers?.length || 1);
                e.splitMembers?.forEach(m => { if(t[m]!==undefined) t[m] += per; });
            });
            return t;
        });

        const filteredExpenses = computed(()=> expenses.value.filter(e => e.date === dates.value[expenseDateIndex.value].date));

        const settlements = computed(()=> {
            const bal = {}; groupMembers.forEach(m=>bal[m]=0);
            filteredExpenses.value.forEach(e=>{
                bal[e.payer] += Number(e.amount||0);
                const per = Number(e.amount||0) / (e.splitMembers?.length || 1);
                e.splitMembers?.forEach(m=> bal[m] -= per);
            });
            const payers = [], recv = [];
            Object.keys(bal).forEach(k=>{
                if(bal[k] > 1) recv.push({name:k,amount:bal[k]});
                else if(bal[k] < -1) payers.push({name:k,amount:Math.abs(bal[k])});
            });
            const out = [];
            payers.forEach(p=>{
                recv.forEach(r=>{
                    if(p.amount>0 && r.amount>0){
                        const s = Math.min(p.amount, r.amount);
                        out.push({from:p.name, to:r.name, amount: Math.round(s)});
                        p.amount -= s; r.amount -= s;
                    }
                });
            });
            return out;
        });

        const calculateCurrency = ()=> currencyResult.value = Math.round((Number(currencyInput.value)||0) * EXCHANGE_RATE);
        const formatNumber = n => (n||n===0) ? String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : '0';
        const getCategoryColor = c => CATEGORY_MAP[c]?.color || 'bg-gray-500';
        const getCategoryIcon = c => CATEGORY_MAP[c]?.icon || 'fa-solid fa-circle';
        const getCategoryLabel = c => ({sightseeing:'æ™¯é»',food:'ç¾é£Ÿ',shopping:'è³¼ç‰©',accommodation:'ä½å®¿',flight:'èˆªç­',transport:'äº¤é€š'}[c]||'å…¶ä»–');
        const getWeatherIcon = c => { if(!c) return 'fa-solid fa-cloud'; const m={snow:'fa-solid fa-snowflake',clear:'fa-solid fa-sun',clouds:'fa-solid fa-cloud',rain:'fa-solid fa-cloud-showers-heavy',mist:'fa-solid fa-smog'}; return m[c.toLowerCase()]||'fa-solid fa-cloud'; };
        const getWeatherDescription = c => { if(!c) return 'è®€å–ä¸­'; const m={snow:'é™é›ª',clear:'æ™´æœ—',clouds:'å¤šé›²',rain:'æœ‰é›¨',drizzle:'æ¯›æ¯›é›¨',thunderstorm:'é›·é›¨',mist:'æœ‰éœ§',fog:'æ¿ƒéœ§'}; return m[c.toLowerCase()]||'å¤šé›²'; };
        const getTransportIcon = t => ({walk:'fa-solid fa-shoe-prints',car:'fa-solid fa-car-side',public:'fa-solid fa-train-subway',flight:'fa-solid fa-plane'}[t]||'fa-solid fa-arrow-right');
        const renderNote = txt => txt ? txt.replace(/(https?:\/\/[^\s]+)/g, u => `<a href="${u}" target="_blank" class="text-blue-500 underline break-all">${u}</a>`) : '';

        const openMap = q => q && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
        const openMapDirections = (s,e) => {
            if(!s||!e) return;
            const origin = encodeURIComponent(s.address || s.name);
            const dest = encodeURIComponent(e.address || e.name);
            const mode = e.transportType === 'car' ? 'driving' : 'transit';
            window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=${mode}`, '_blank');
        };

        const syncToFirebase = ()=> tripRef.set({
            itineraryData: JSON.parse(JSON.stringify(itineraryData.value)),
            shoppingList: JSON.parse(JSON.stringify(shoppingList.value)),
            expenses: JSON.parse(JSON.stringify(expenses.value))
        });

        // ä¿®æ­£ï¼šå°‡æ‰€æœ‰å‡½å¼ç§»å‡º handleAddClick
      const handleAddClick = () => {
    // ç¢ºä¿æ¯æ¬¡é»æ“Šéƒ½å…ˆæ¸…ç©ºæ‰€æœ‰å½ˆçª—ç‹€æ…‹
    showItineraryModal.value = false;
    showShoppingModal.value = false;
    showExpenseModal.value = false;

    // æª¢æŸ¥ç•¶å‰åˆ†é ä¸¦é–‹å•Ÿå°æ‡‰å½ˆçª—
    if (currentTab.value === 'itinerary') {
        isEditMode.value = false;
        newItinerary.value = { 
            id: Date.now(), name: '', category: 'sightseeing', startTime: '', 
            address: '', note: '', transportType: 'car', travelTime: '', 
            transNote: '', transitTime: '', isNoteExpanded: false 
        };
        showItineraryModal.value = true;
    } 
    else if (currentTab.value === 'shopping') {
        // é‡è¨­è³¼ç‰©æ¸…å–®æš«å­˜ä¸¦é–‹å•Ÿ
        newShoppingItem.value = { name: '', image: null };
        showShoppingModal.value = true;
    } 
    else if (currentTab.value === 'expenses') {
        // é‡è¨­è¨˜å¸³æš«å­˜ä¸¦é–‹å•Ÿ
        newExpense.value = { 
            name: '', amount: null, category: 'food', 
            date: dates.value[expenseDateIndex.value].date, 
            payer: groupMembers[0], 
            splitMembers: [...groupMembers] 
        };
        showExpenseModal.value = true;
    }
};
        const saveItineraryItem = ()=>{
            const list = itineraryData.value[selectedDateIndex.value];
            if(isEditMode.value){
                const i = list.findIndex(x=>x.id===newItinerary.value.id);
                if(i!==-1) list[i] = { ...newItinerary.value };
            } else {
                list.push({ ...newItinerary.value, id: Date.now() });
            }
            showItineraryModal.value = false; syncToFirebase();
        };

        const deleteItineraryItem = ()=> {
            if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')){
                const list = itineraryData.value[selectedDateIndex.value];
                const i = list.findIndex(x=>x.id===newItinerary.value.id);
                if(i!==-1){ list.splice(i,1); showItineraryModal.value=false; syncToFirebase(); }
            }
        };

        const editItem = itm => { isEditMode.value=true; newItinerary.value = JSON.parse(JSON.stringify(itm)); showItineraryModal.value=true; };
        const moveItineraryUp = id => { const l = itineraryData.value[selectedDateIndex.value]; const i=l.findIndex(x=>x.id===id); if(i>0){ [l[i-1],l[i]]=[l[i],l[i-1]]; syncToFirebase(); } };
        const moveItineraryDown = id => { const l = itineraryData.value[selectedDateIndex.value]; const i=l.findIndex(x=>x.id===id); if(i<l.length-1){ [l[i+1],l[i]]=[l[i],l[i+1]]; syncToFirebase(); } };

        const handleImageUpload = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // 1. æ”¾å¯¬é™åˆ¶åˆ° 5MB
    const MAX_SIZE = 5 * 1024 * 1024; 
    if (file.size > MAX_SIZE) {
        alert('åœ–ç‰‡å¤ªå¤§å›‰ï¼Œè«‹é¸æ“‡å°æ–¼ 5MB çš„ç…§ç‰‡');
        return;
    }

    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.src = ev.target.result;
        img.onload = () => {
            // 2. åœ–ç‰‡å£“ç¸®é‚è¼¯
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // è¨­å®šæœ€å¤§å¯¬åº¦ç‚º 800pxï¼ŒæŒ‰æ¯”ä¾‹ç¸®æ”¾
            const MAX_WIDTH = 800;
            if (width > MAX_WIDTH) {
                height = (MAX_WIDTH / width) * height;
                width = MAX_WIDTH;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // 3. è½‰æˆå£“ç¸®å¾Œçš„ Base64 (å“è³ª 0.7)
            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
            newShoppingItem.value.image = compressedBase64;
        };
    };
    reader.readAsDataURL(file);
};

        const addShoppingItem = ()=>{
            if(!newShoppingItem.value.name) return;
            shoppingList.value.push({ id: Date.now(), name: newShoppingItem.value.name, image: newShoppingItem.value.image, buyer: selectedBuyer.value });
            showShoppingModal.value = false; newShoppingItem.value = { name:'', image:null }; syncToFirebase();
        };

        const removeShoppingItem = id=>{
            const i = shoppingList.value.findIndex(x=>x.id===id);
            if(i!==-1){ shoppingList.value.splice(i,1); syncToFirebase(); }
        };

        const toggleSplitMember = m => {
            const idx = newExpense.value.splitMembers.indexOf(m);
            if(idx > -1){ if(newExpense.value.splitMembers.length > 1) newExpense.value.splitMembers.splice(idx,1); }
            else newExpense.value.splitMembers.push(m);
        };

        const addExpense = ()=>{
            if(!newExpense.value.amount || !newExpense.value.name) return;
            newExpense.value.date = dates.value[expenseDateIndex.value].date;
            expenses.value.push({...newExpense.value});
            showExpenseModal.value = false;
            newExpense.value = { name:'', amount:null, category:'food', date:'', payer:groupMembers[0], splitMembers:[...groupMembers] };
            syncToFirebase();
        };

        const removeExpense = item => {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—ï¼Ÿ')){
                const i = expenses.value.findIndex(e=>e===item);
                if(i!==-1){ expenses.value.splice(i,1); syncToFirebase(); }
            }
        };

        const fetchWeather = async ()=>{
            const idx = selectedDateIndex.value;
            let city = idx <= 2 ? 'Sendai' : (idx === 3 ? 'Matsushima' : 'Tokyo');
            try{
                const apiKey = '5e1e88597b11b5dbf9f550ee7b26e17a';
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city},JP&units=metric&appid=${apiKey}&lang=zh_tw&_=${Date.now()}`);
                const data = await res.json();
                if(data?.weather && data?.main){
                    const cur = Math.round(data.main.temp);
                    weatherData.value[idx] = {
                        condition: data.weather[0].main.toLowerCase(),
                        tempMax: data.main.temp_max === data.main.temp_min ? cur + 3 : Math.round(data.main.temp_max),
                        tempMin: data.main.temp_max === data.main.temp_min ? cur - 2 : Math.round(data.main.temp_min),
                        feel: Math.round(data.main.feels_like),
                        locationName: city === 'Sendai' ? 'ä»™å°' : city === 'Matsushima' ? 'æ¾å³¶' : 'å…©åœ‹ (æ±äº¬)'
                    };
                }
            } catch(e){ console.error('å¤©æ°£æ›´æ–°å¤±æ•—', e); }
        };
        watch(selectedDateIndex, ()=>fetchWeather(), { immediate:true });

        onMounted(()=>{
            calculateCurrency();
            tripRef.on('value', snap => {
                const d = snap.val();
                if(!d) return;
                if(d.itineraryData) itineraryData.value = d.itineraryData;
                if(d.shoppingList) shoppingList.value = d.shoppingList;
                if(d.expenses) expenses.value = d.expenses;
            });
        });
return {
            EXCHANGE_RATE, currentTab, dates, selectedDateIndex, itineraryData, currentItinerary, hotels, shoppingList, expenses,
            weatherData, currencyInput, currencyResult, calculateCurrency, formatNumber, getCategoryColor, getCategoryIcon, getCategoryLabel,
            getWeatherIcon, getWeatherDescription, getTransportIcon, renderNote, openMap, openMapDirections, handleAddClick,
            showItineraryModal, showShoppingModal, showExpenseModal, isEditMode, newItinerary, newShoppingItem, newExpense,
            saveItineraryItem, deleteItineraryItem, editItem, moveItineraryUp, moveItineraryDown, addShoppingItem, removeShoppingItem,
            addExpense, removeExpense, buyers, selectedBuyer, filteredShoppingList, expenseDateIndex, handleImageUpload, groupMembers,
            settlements, toggleSplitMember, dailyExpenses, personOwes, filteredExpenses
        };
    }
}).mount('#app');
</script>
</body>
</html>
